<div class="dui-container">
    {{#if isGM}}
    <div class="dui-toolbar">
        <div class="dui-toggle-type">
            <button type="button" class="dui-rest-btn {{#if isShort}}active{{/if}}" data-action="setRestType" data-rest-type="short">
                <i class="fas fa-campground"></i> Short
            </button>
            <button type="button" class="dui-rest-btn {{#if isLong}}active{{/if}}" data-action="setRestType" data-rest-type="long">
                <i class="fas fa-bed"></i> Long
            </button>
        </div>
        <button type="button" class="dui-moves-btn" data-action="openMovesConfig">
            <i class="fas fa-plus-circle"></i> Moves
        </button>
        <button type="button" class="dui-start-btn" data-action="startDowntime">
            <i class="fas fa-play" style="font-size: 10px;"></i> Start Downtime
        </button>
        <button type="button" class="dui-resend-btn" data-action="resendDowntime" title="Re-open Downtime UI for all players">
            <i class="fas fa-share-square"></i>
        </button>
    </div>
    {{/if}}

    <!-- Header visible only to players -->
    {{#unless isGM}}
    <div class="dui-rest-header">{{restLabel}}</div>
    {{/unless}}

    <div class="dui-player-list">
        {{#each rows}}
        <!-- Added 'player-view' class if not GM to adjust Grid in CSS -->
        <div class="dui-row {{#unless this.included}}dui-row--excluded{{/unless}} {{#unless this.isGM}}player-view{{/unless}} {{#if this.hasPrepare}}dui-row--preparing{{/if}}" data-actor-id="{{this.actorId}}">

            <!-- This column exists only for the GM -->
            {{#if this.isGM}}
            <div class="dui-controls-col">
                <button type="button" class="dui-toggle-switch {{#if this.included}}checked{{/if}}" data-action="toggleIncluded" data-actor-id="{{this.actorId}}" title="Include in Downtime">
                    <span class="dui-toggle-slider"></span>
                </button>
                <button type="button" class="dui-config-btn" data-action="configMaxChoices" data-actor-id="{{this.actorId}}" title="Configure">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
            {{/if}}

            <!-- Identity Column -->
            <div class="dui-identity">
                <img class="dui-avatar" src="{{this.avatar}}" alt="{{this.actorName}}" />
                <div class="dui-info-text">
                    <span class="dui-actor-name">{{this.actorName}}</span>
                    <span class="dui-user-name">
                        (<span class="dui-user-dot" style="--user-color: {{this.userColor}};"></span>{{this.userName}})
                    </span>
                </div>
            </div>

            <div class="dui-badges-container">
                {{#if this.domainCardStatus}}
                <div class="dui-domain-card-badge {{this.domainCardStatus.type}}">
                    <span class="dui-domain-card-label">{{this.domainCardStatus.count}}</span>
                    <i class="fas fa-clone"></i>
                    <span class="dui-domain-card-tooltip">{{this.domainCardStatus.message}}</span>
                </div>
                {{/if}}

                {{#if this.refreshFeatures.length}}
                <div class="dui-refresh-badge">
                    <span class="dui-refresh-label">Refreshing Resources</span>
                    <i class="fas fa-sync-alt"></i>
                    <span class="dui-refresh-tooltip">
                        {{#each this.refreshFeatures}}
                        <span class="dui-refresh-feature">{{this}}</span>
                        {{/each}}
                    </span>
                </div>
                {{/if}}
            </div>

            <!-- Actions Column -->
            <div class="dui-actions-wrapper">
                <div class="dui-actions">
                    {{#each this.actions}}
                        {{#if this.hasTarget}}
                             <div class="dui-action-group {{#if this.selected}}active{{/if}} {{#if this.isEfficientSlot}}efficient{{/if}}">
                                <button type="button" class="dui-action-btn" data-action="toggleAction" data-actor-id="{{../actorId}}" data-action-key="{{this.key}}" {{#if this.cannotSelect}}disabled{{/if}} {{#unless ../canInteract}}disabled{{/unless}}>
                                    {{this.label}}
                                </button>

                                {{#if this.selected}}
                                <select class="dui-target-select" data-actor-id="{{../actorId}}" data-action-key="{{this.key}}" {{#unless ../canInteract}}disabled{{/unless}}>
                                    {{#each ../targetOptions}}
                                    <option value="{{this.id}}" {{#if (eq this.id ../targetActorId)}}selected{{/if}}>{{this.name}}</option>
                                    {{/each}}
                                </select>
                                {{/if}}
                                {{#if this.canBeEfficientSlot}}
                                <button type="button" class="dui-efficient-badge {{#if this.isEfficientSlot}}active{{/if}}" data-action="toggleEfficientSlot" data-actor-id="{{../actorId}}" data-action-key="{{this.key}}" {{#unless ../canInteract}}disabled{{/unless}} title="{{#if this.isEfficientSlot}}Remove Efficient Slot{{else}}Use as Efficient Slot (Long Rest effect){{/if}}">
                                    <i class="fas fa-star"></i>
                                </button>
                                {{/if}}
                            </div>
                        {{else}}
                            {{#if this.isBonusMove}}
                            <div class="dui-action-group dui-bonus-move {{#if this.selected}}active{{/if}}">
                                <button type="button" class="dui-action-btn" data-action="toggleAction" data-actor-id="{{../actorId}}" data-action-key="{{this.key}}" {{#unless ../canInteract}}disabled{{/unless}}>
                                    <i class="fas fa-leaf"></i> {{this.label}}
                                </button>
                                {{#if this.selected}}
                                <select class="dui-forager-select" data-actor-id="{{../actorId}}" {{#unless ../canInteract}}disabled{{/unless}} title="Your choice if you roll a 6">
                                    {{#each ../../foragerOptions}}
                                    <option value="{{this.value}}" {{#if (eq this.value ../../foragerChoice)}}selected{{/if}}>{{this.label}}</option>
                                    {{/each}}
                                </select>
                                {{/if}}
                            </div>
                            {{else}}
                            <div class="dui-action-wrapper">
                            <button type="button" class="dui-action-btn standalone {{#if this.selected}}selected{{/if}} {{#if this.isEfficientSlot}}efficient{{/if}}" data-action="toggleAction" data-actor-id="{{../actorId}}" data-action-key="{{this.key}}" {{#if this.cannotSelect}}disabled{{/if}} {{#unless ../canInteract}}disabled{{/unless}}>
                                {{this.label}}
                            </button>
                            {{#if this.canBeEfficientSlot}}
                            <button type="button" class="dui-efficient-badge {{#if this.isEfficientSlot}}active{{/if}}" data-action="toggleEfficientSlot" data-actor-id="{{../actorId}}" data-action-key="{{this.key}}" {{#unless ../canInteract}}disabled{{/unless}} title="{{#if this.isEfficientSlot}}Remove Efficient Slot{{else}}Use as Efficient Slot (Long Rest effect){{/if}}">
                                <i class="fas fa-star"></i>
                            </button>
                            {{/if}}
                            </div>
                            {{/if}}
                        {{/if}}
                    {{/each}}
                </div>
            </div>

            <!-- Feature rows below moves list -->
            {{#if this.showFeaturesRow}}
            <div class="dui-features-row">
                {{#if this.hasEloquent}}
                <div class="dui-eloquent-selector-below">
                    <span class="dui-eloquent-label">Eloquent:</span>
                    <select class="dui-eloquent-select" data-actor-id="{{this.actorId}}" {{#unless this.canInteract}}disabled{{/unless}} title="Eloquent: Grant bonus move to a companion">
                        <option value="">Choose a friend...</option>
                        {{#each this.eloquentOptions}}
                        {{#if this.id}}
                        <option value="{{this.id}}" {{#if (eq this.id ../eloquentBeneficiary)}}selected{{/if}}>â†’ {{this.name}}</option>
                        {{/if}}
                        {{/each}}
                    </select>
                </div>
                {{/if}}

                {{#if this.hasEfficient}}{{#if ../isShort}}
                <div class="dui-efficient-indicator">
                    <i class="fas fa-star"></i>
                    <span class="dui-efficient-text">Efficient</span>
                    <span class="dui-efficient-tooltip">Can upgrade one action to Long Rest quality</span>
                </div>
                {{/if}}{{/if}}

                {{#if this.hasSoothingSpeech}}
                <div class="dui-efficient-indicator">
                    <i class="fas fa-comment-medical"></i>
                    <span class="dui-efficient-text">Soothing Speech</span>
                    <span class="dui-efficient-tooltip">Tend to Wounds on another: +1 HP on target, +2 HP on yourself</span>
                </div>
                {{/if}}

                {{#if this.hasArmorer}}
                <div class="dui-efficient-indicator">
                    <i class="fas fa-shield-alt"></i>
                    <span class="dui-efficient-text">Armorer</span>
                    <span class="dui-efficient-tooltip">When you Repair Armor, all allies also clear an Armor Slot</span>
                </div>
                {{/if}}
            </div>
            {{/if}}

            <!-- Counter Column -->
            <div class="dui-counter">
                <span class="dui-count-label">Moves</span>
                <span class="dui-count-val" {{#if this.isOverLimit}}style="color: #ff6b6b;"{{/if}}>{{this.selectedCount}}/{{this.maxChoices}}</span>
            </div>

        </div>
        {{else}}
        <div class="dui-empty">
            <i class="fas fa-users-slash"></i>
            <p>No players found.</p>
        </div>
        {{/each}}
    </div>

</div>