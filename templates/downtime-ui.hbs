<div class="dui-container">

    {{#if isGM}}
    <div class="dui-toolbar">
        <div class="dui-toggle-type">
            <button type="button" class="dui-rest-btn {{#if isShort}}active{{/if}}" data-action="setRestType" data-rest-type="short">
                <i class="fas fa-campground"></i> Short
            </button>
            <button type="button" class="dui-rest-btn {{#if isLong}}active{{/if}}" data-action="setRestType" data-rest-type="long">
                <i class="fas fa-bed"></i> Long
            </button>
        </div>
        <button type="button" class="dui-start-btn" data-action="startDowntime">
            <i class="fas fa-play" style="font-size: 10px;"></i> Start Downtime
        </button>
    </div>
    {{/if}}

    <!-- UPDATED: Rest Label Header (Only visible to non-GMs) -->
    {{#unless isGM}}
    <div class="dui-rest-header">{{restLabel}}</div>
    {{/unless}}

    <div class="dui-player-list">
        {{#each rows}}
        <div class="dui-row {{#unless this.included}}dui-row--excluded{{/unless}}" data-actor-id="{{this.actorId}}">

            <!-- Checkbox / Config Column -->
            <div class="dui-controls-col">
                {{#if this.isGM}}
                    <!-- Include Toggle -->
                    <button type="button" class="dui-checkbox-btn {{#if this.included}}checked{{/if}}" data-action="toggleIncluded" data-actor-id="{{this.actorId}}" title="Include in Downtime">
                        <i class="fas fa-check"></i>
                    </button>
                    <!-- Config Button -->
                    <button type="button" class="dui-config-btn" data-action="configMaxChoices" data-actor-id="{{this.actorId}}" title="Configure">
                        <i class="fas fa-cog"></i>
                    </button>
                {{/if}}
                <!-- Non-GMs see nothing here, column collapses or stays empty based on grid -->
            </div>

            <!-- Identity Column -->
            <div class="dui-identity">
                <img class="dui-avatar" src="{{this.avatar}}" alt="{{this.actorName}}" />
                <div class="dui-info-text">
                    <span class="dui-actor-name">
                        {{this.actorName}}
                    </span>
                    <span class="dui-user-name">
                        <span class="dui-user-dot" style="--user-color: {{this.userColor}};"></span>
                        {{this.userName}}
                    </span>
                </div>
            </div>

            <!-- Actions Column -->
            <div class="dui-actions">
                {{#each this.actions}}
                    <!-- If action has target (and is selected), group button + select. Otherwise just button -->
                    {{#if this.hasTarget}}
                         <div class="dui-action-group {{#if this.selected}}active{{/if}}">
                            <button type="button" class="dui-action-btn" data-action="toggleAction" data-actor-id="{{../actorId}}" data-action-key="{{this.key}}" {{#if this.cannotSelect}}disabled{{/if}} {{#unless ../canInteract}}disabled{{/unless}}>
                                {{this.label}}
                            </button>
                            
                            {{#if this.selected}}
                            <select class="dui-target-select" data-actor-id="{{../actorId}}" data-action-key="{{this.key}}" {{#unless ../canInteract}}disabled{{/unless}}>
                                {{#each ../targetOptions}}
                                <option value="{{this.id}}" {{#if (eq this.id ../../targetActorId)}}selected{{/if}}>{{this.name}}</option>
                                {{/each}}
                            </select>
                            {{/if}}
                        </div>
                    {{else}}
                        <!-- Simple Button (no target) -->
                        <button type="button" class="dui-action-btn standalone {{#if this.selected}}selected{{/if}}" data-action="toggleAction" data-actor-id="{{../actorId}}" data-action-key="{{this.key}}" {{#if this.cannotSelect}}disabled{{/if}} {{#unless ../canInteract}}disabled{{/unless}}>
                            {{this.label}}
                        </button>
                    {{/if}}
                {{/each}}
            </div>

            <!-- Counter Column -->
            <div class="dui-counter">
                <span class="dui-count-val">{{this.selectedCount}} / {{this.maxChoices}}</span>
                <span>Actions</span>
            </div>

        </div>
        {{else}}
        <div class="dui-empty">
            <i class="fas fa-users-slash"></i>
            <p>No players found.</p>
        </div>
        {{/each}}
    </div>

</div>